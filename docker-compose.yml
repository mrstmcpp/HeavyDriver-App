
services:
  # -----------------------
  # Infra
  # -----------------------
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: hddatabase
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - heavydrivernet
    restart: unless-stopped

  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - heavydrivernet
    restart: unless-stopped

  kafka:
    image: apache/kafka:4.1.1
    container_name: kafka
    ports:
    - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      
      # --- ADD THESE LINES ---
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      # -----------------------

    volumes:
      - kafka-data-fresh:/var/lib/kafka/data
    networks:
      - heavydrivernet
    restart: unless-stopped

  # -----------------------
  # Entity Service (DB Init)
  # -----------------------
  entity-service:
    build:
      context: ./HD-EntityService
      dockerfile: Dockerfile
    container_name: hd-entity-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    networks:
      - heavydrivernet
    depends_on:
      - mysql
    restart: "no"

  # -----------------------
  # Discovery
  # -----------------------
  hd-eureka-service:
    build:
      context: ./HD-ServiceDiscovery
      dockerfile: Dockerfile
    container_name: hd-eureka-service
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    networks:
      - heavydrivernet
    depends_on:
      - mysql
    restart: unless-stopped

  # -----------------------
  # API Gateway
  # -----------------------
  api-gateway:
    build:
      context: ./HeavyDriver-ApiGateway
      dockerfile: Dockerfile
    container_name: hd-api-gateway
    ports:
      - "3006:3006"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://hd-eureka-service:8761/eureka/
    networks:
      - heavydrivernet
    depends_on:
      - hd-eureka-service
      - redis
    restart: unless-stopped

  # -----------------------
  # Backend microservices
  # -----------------------
  auth-service:
    build:
      context: .
      dockerfile: HD-AuthProject/Dockerfile
    container_name: hd-auth-service
    ports:
      - "3001:3001"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=root
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://hd-eureka-service:8761/eureka/
    networks:
      - heavydrivernet
    depends_on:
      - mysql
      - redis
      - kafka
      - hd-eureka-service
    restart: unless-stopped

  booking-service:
    build:
      context: .
      dockerfile: HD-BookingService/Dockerfile
    container_name: hd-booking-service
    ports:
      - "3002:3002"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=root
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://hd-eureka-service:8761/eureka/
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
    networks:
      - heavydrivernet
    depends_on:
      - mysql
      - redis
      - kafka
      - hd-eureka-service
      - entity-service
    restart: unless-stopped

  review-service:
    build:
      context: .
      dockerfile: HD-ReviewService/Dockerfile
    container_name: hd-review-service
    ports:
      - "3000:3000"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://hd-eureka-service:8761/eureka/
    networks:
      - heavydrivernet
    depends_on:
      - mysql
      - redis
      - hd-eureka-service
      - entity-service
    restart: unless-stopped

  fare-service:
    build:
      context: .
      dockerfile: HD-FareService/Dockerfile
    container_name: hd-fare-service
    ports:
      - "3008:3008"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://hd-eureka-service:8761/eureka/
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
    networks:
      - heavydrivernet
    depends_on:
      - mysql
      - kafka
      - hd-eureka-service
      - entity-service
    restart: unless-stopped

  location-service:
    build:
      context: .
      dockerfile: HD-LocationService/Dockerfile
    container_name: hd-location-service
    ports:
      - "3005:3005"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://hd-eureka-service:8761/eureka/
    networks:
      - heavydrivernet
    depends_on:
      - hd-eureka-service
      - redis
      - kafka
      - mysql
      - entity-service
    restart: unless-stopped

  socket-service:
    build:
      context: .
      dockerfile: HD-ClientSocketService/Dockerfile
    container_name: hd-socket-service
    ports:
      - "3004:3004"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://hd-eureka-service:8761/eureka/
    networks:
      - heavydrivernet
    depends_on:
      - hd-eureka-service
      - redis
      - kafka
      - mysql
    restart: unless-stopped

  # -----------------------
  # Frontends (Vite -> build-time env args)
  # -----------------------
  frontend-passenger:
    build:
      context: ./heavydriver-frontend
      dockerfile: Dockerfile
      args:
        # use API gateway (service name) and socket service name
        VITE_GATEWAY_BACKEND_URL: "http://localhost:3006/api/v1"
        VITE_AUTH_BACKEND_URL: "http://localhost:3006/api/v1/auth"
        VITE_BOOKING_BACKEND_URL: "http://localhost:3006/api/v1/booking"
        VITE_REVIEW_BACKEND_URL: "http://localhost:3006/api/v1/review"
        VITE_FARE_BACKEND_URL: "http://localhost:3006/api/v1/booking"
        VITE_LOCATION_BACKEND_URL: "http://localhost:3006/api/v1/location"
        VITE_SOCKET_URL: "http://localhost:3004/ws"
        VITE_GOOGLE_MAPS_API_KEY: "${GOOGLE_MAPS_API_KEY}"
        VITE_GOOGLE_MAPS_MAP_ID: "${GOOGLE_MAPS_MAP_ID}"
    container_name: frontend-passenger
    ports:
      - "8080:80" # host 8080 -> container 80 (nginx)
    networks:
      - heavydrivernet
    depends_on:
      - api-gateway
      - socket-service
    restart: unless-stopped

  frontend-driver:
    build:
      context: ./WebSocketClient
      dockerfile: Dockerfile
      args:
        VITE_GATEWAY_BACKEND_URL: "http://localhost:3006/api/v1"
        VITE_AUTH_BACKEND_URL: "http://localhost:3006/api/v1/auth"
        VITE_BOOKING_BACKEND_URL: "http://localhost:3006/api/v1/booking"
        VITE_REVIEW_BACKEND_URL: "http://localhost:3006/api/v1/review"
        VITE_FARE_BACKEND_URL: "http://localhost:3006/api/v1/booking"
        VITE_LOCATION_BACKEND_URL: "http://localhost:3006/api/v1/location"
        VITE_SOCKET_URL: "http://localhost:3004/ws"
        VITE_SOCKET_BACKEND_URL: "http://localhost:3004/ws"
        VITE_GOOGLE_MAPS_API_KEY: "${GOOGLE_MAPS_API_KEY}"
        VITE_GOOGLE_MAPS_MAP_ID: "${GOOGLE_MAPS_MAP_ID}"
        VITE_DRIVER_BACKEND_URL: "http://localhost:3006/api/v1/driver"
        VITE_PASSENGER_FRONTEND: "http://frontend-passenger:80"
    container_name: frontend-driver
    ports:
      - "8081:80" # host 8081 -> container 80 (nginx)
    networks:
      - heavydrivernet
    depends_on:
      - api-gateway
      - socket-service
    restart: unless-stopped

volumes:
  mysql_data:
  kafka-data-fresh:

networks:
  heavydrivernet:
    driver: bridge
